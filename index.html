<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guias para Orçamento</title>
    <style>
        /* Variáveis CSS para Temas */
        :root {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --sub-card: #333333;
            --text: #ffffff;
            --input-bg: #3d3d3d;
            --border: #444;
            --primary: #2ecc71;
            --danger: #ff4757;
            --shopee: #ee4d2d;
            --ml: #ffe600;
        }

        body.light-mode {
            --bg: #f0f2f5;
            --card: #ffffff;
            --sub-card: #f9f9f9;
            --text: #333333;
            --input-bg: #e4e6eb;
            --border: #ccc;
        }

        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            transition: background 0.3s, color 0.3s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        button, input, select { touch-action: manipulation; }

        /* --- TOP BAR --- */
        .top-bar { 
            width: 100%; max-width: 520px; 
            height: 45px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            margin-bottom: 10px; 
            position: relative; 
        }

        .app-title {
            font-size: 16px; font-weight: 600; color: #888;
            text-transform: uppercase; letter-spacing: 0.5px;
            margin: 0; user-select: none;
        }

        .header-actions {
            position: absolute; right: 0; top: 0; height: 100%;
            display: flex; align-items: center; gap: 5px;
        }
        
        .gear-btn { 
            background: none; border: none; 
            cursor: pointer; color: #888; 
            padding: 8px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: all 0.3s ease;
        }
        
        .gear-btn svg {
            width: 24px; height: 24px; stroke: currentColor;
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none;
        }

        .gear-btn:hover { color: var(--text); background-color: rgba(128, 128, 128, 0.1); }
        .gear-rotate:hover svg { transform: rotate(90deg); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Menu Configurações */
        .settings-menu {
            display: none; position: absolute; top: 50px; right: 0; 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100; width: 230px;
        }
        .settings-menu.open { display: block; }
        .settings-section { margin-bottom: 15px; }
        .settings-title { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        
        .theme-toggle { display: flex; background: var(--input-bg); border-radius: 20px; padding: 2px; cursor: pointer; }
        .theme-opt { flex: 1; text-align: center; padding: 6px; font-size: 12px; border-radius: 18px; transition: 0.2s; color: var(--text); }
        .theme-opt.active { background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; }

        .color-grid { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; align-items: center; }
        .color-swatch { 
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer; 
            border: 2px solid transparent; box-sizing: border-box; 
            display: flex; align-items: center; justify-content: center;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: var(--text); transform: scale(1.1); }

        .custom-picker-btn {
            background: var(--input-bg); border: 1px dashed #888;
            color: #888; font-size: 18px; font-weight: bold;
            transition: all 0.2s; padding: 0; margin: 0; line-height: 0;
        }
        .custom-picker-btn.active { border: 2px solid var(--text); border-style: solid; color: transparent; }
        .custom-picker-btn:hover { border-color: var(--text); color: var(--text); }
        .custom-picker-btn span { display: block; margin-top: -2px; }

        .custom-color-modal {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 10px;
            background: var(--card); border: 1px solid var(--border);
            padding: 15px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 101; width: 200px;
            flex-direction: column; gap: 10px;
        }
        .custom-color-modal.open { display: flex; }
        
        .color-preview-box {
            width: 100%; height: 40px; border-radius: 8px; 
            border: 1px solid var(--border); background-color: var(--primary);
            transition: background 0.1s; margin-bottom: 5px;
        }
        
        .slider-group { display: flex; flex-direction: column; gap: 2px; }
        .slider-label { font-size: 10px; color: #888; }
        
        .custom-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; outline: none; cursor: pointer; margin: 5px 0; }
        .custom-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 1px solid #888; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        #hueSlider { background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); }
        #satSlider { background: linear-gradient(to right, #888, var(--primary)); }
        #ligSlider { background: linear-gradient(to right, #000, var(--primary), #fff); }

        .main-card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 520px; margin-bottom: 20px; box-sizing: border-box; transition: background 0.3s; }
        .main-title-box { cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding-bottom: 10px; }
        h2 { text-align: center; color: var(--primary); margin: 0; font-size: 22px; }
        
        #mainContentWrapper { transition: all 0.3s ease-in-out; overflow: hidden; max-height: 5000px; opacity: 1; }
        #mainContentWrapper.collapsed { max-height: 0; opacity: 0; }

        .sub-section { background: var(--sub-card); padding: 15px; border-radius: 15px; margin-top: 25px; border: 1px solid var(--border); }

        label { display: block; margin: 12px 0 5px; font-weight: 600; font-size: 14px; color: #888; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--input-bg); color: var(--text); font-size: 16px; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { filter: brightness(1.1); }
        
        .side-by-side { display: flex; gap: 10px; width: 100%; }
        .side-by-side > div { flex: 1; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Input Locked Style */
        .input-locked { background-color: rgba(0,0,0,0.2) !important; color: #888 !important; pointer-events: none; border-color: transparent !important; }

        .header-config { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-btns { display: flex; gap: 8px; align-items: center; }
        
        .btn-icon-simple, .btn-icon-drag, .btn-icon-delete, .extra-chip-rm {
            background: none; border: none; 
            color: var(--primary) !important;
            cursor: pointer; 
            line-height: 1; 
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            opacity: 1 !important;
        }

        .btn-icon-simple { font-size: 20px; font-weight: bold; padding: 6px; border-radius: 6px; border: 1px solid transparent; }
        .btn-edit-active { background-color: var(--primary) !important; color: #fff !important; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .btn-icon-simple:not(.btn-edit-active):hover { background-color: rgba(128, 128, 128, 0.1); opacity: 1 !important; }
        .btn-edit-active:hover { filter: brightness(1.1); }
        .btn-icon-drag:hover, .btn-icon-delete:hover, .extra-chip-rm:hover { opacity: 0.7 !important; }

        .btn-confirm-style { background: var(--primary); color: #fff; border: none; border-radius: 4px; padding: 8px 15px; font-weight: bold; cursor: pointer; font-size: 14px; }

        .setup-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        .setup-table th, .setup-table td { border: 1px solid var(--border); padding: 8px 2px; text-align: center; vertical-align: middle; height: 45px; box-sizing: border-box; color: var(--text); }
        .setup-table input { padding: 6px; font-size: 10px; border-radius: 4px; background: var(--bg); color: var(--text); border: 1px solid var(--border); width: 90%; }
        
        .col-ctrl { width: 35px; border: none !important; padding: 0 !important; } 
        .ctrl-icon-box { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; min-height: 45px; }
        .handle { cursor: grab; touch-action: none; }

        .selector-row { background: var(--input-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .selector-row span { color: var(--primary); font-weight: bold; font-size: 18px; }
        .arrow-down { border: solid #888; border-width: 0 3px 3px 0; display: inline-block; padding: 3px; transform: rotate(45deg); margin-bottom: 5px; }
        
        details { background: var(--card); border-radius: 0 0 10px 10px; border: 1px solid var(--border); border-top: none; overflow: hidden; margin-top: 0; }
        summary { display: none; }
        
        .suggest-item-row { border-bottom: 1px solid var(--border); display: flex; align-items: center; }
        .suggest-item-row:last-child { border-bottom: none; }
        .suggest-data { flex-grow: 1; padding: 12px; color: var(--text); display: flex; justify-content: space-between; cursor: pointer; font-size: 12px; }
        .suggest-data.selected { background: rgba(128, 128, 128, 0.1); border-left: 3px solid var(--primary); }
        .suggest-edit-input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 4px; font-size: 11px; border-radius: 4px; width: 80%; }
        
        .suggest-footer { display: flex; border-top: 1px solid var(--border); background: var(--bg); }
        .btn-footer-suggest { flex: 1; padding: 10px; background: none; border: none; color: #888; font-size: 11px; border-right: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .btn-footer-suggest:last-child { border-right: none; flex: 0 0 45px; font-size: 20px; }
        .btn-footer-suggest.active { color: var(--primary); font-weight: bold; }

        .temp-add-row { display: none; background: var(--input-bg); padding: 8px; border-top: 1px solid var(--border); align-items: center; gap: 5px; }
        .temp-add-row.active { display: flex; }
        .btn-confirm-add { background: var(--primary); color: #fff; border: none; border-radius: 4px; width: 30px; height: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .formula-radios { display: flex; gap: 10px; margin-bottom: 10px; }
        .formula-opt { flex: 1; text-align: center; }
        .formula-opt input { display: none; }
        .formula-opt label { margin: 0; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: #888; transition: all 0.2s; font-size: 13px; font-weight: normal; }
        .formula-opt input:checked + label { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }

        .extras-chips-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .extra-chip { background: var(--input-bg); border: 1px solid var(--border); padding: 5px 10px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; color: var(--text); }
        .extra-chip span { color: var(--primary); font-weight: bold; }
        .extra-chip-rm { cursor: pointer; font-weight: bold; margin-left: 5px; color: var(--primary); }

        .extra-section { margin-top: 25px; }
        .extra-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        .btn-simple-toggle { background: none; border: none; color: var(--primary); font-size: 28px; line-height: 1; cursor: pointer; font-weight: bold; padding: 0 5px; transition: opacity 0.2s; }
        .btn-simple-toggle:hover { opacity: 0.8; }

        .result { margin-top: 20px; padding: 20px; background: rgba(128, 128, 128, 0.05); border: 1px solid var(--primary); border-radius: 15px; text-align: center; }
        .result-title { font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        .result-main-value { display: block; font-size: 32px; color: var(--primary); font-weight: bold; margin-bottom: 15px; } 
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-top: 1px solid var(--border); font-size: 12px; color: #888; }
        .detail-row.total-custo { color: var(--text); font-weight: bold; border-top: 1px solid var(--border); margin-top: 5px; padding-top: 8px; }
        
        /* ESTILOS PLATAFORMAS (Sem moldura/fundo) */
        .platform-row { margin: 0 0 15px 0; text-align: center; }
        .platform-title { font-size: 10px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; margin-bottom: 4px; }
        
        .shopee-title { color: var(--shopee); }
        .ml-title { color: var(--ml); }
        
        .platform-value-row { display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .shopee-main-value { font-size: 26px; color: var(--shopee); font-weight: bold; line-height: 1; }
        .ml-main-value { font-size: 26px; color: var(--ml); font-weight: bold; line-height: 1; }
        
        .percent-tag { font-size: 11px; color: #fff; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .tag-shopee { background: var(--shopee); box-shadow: 0 2px 5px rgba(238, 77, 45, 0.3); }
        .tag-ml { background: var(--ml); color: #000; box-shadow: 0 2px 5px rgba(255, 230, 0, 0.3); }

        .form-novo { display: none; background: var(--card); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px dashed var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .helper-text { font-size: 11px; color: #777; margin-top: 5px; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1 class="app-title">Guias para Orçamento</h1>
    <div class="header-actions">
        <button class="gear-btn" onclick="downloadApp()" title="Trabalhar Offline"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
        <button class="gear-btn gear-rotate" onclick="toggleSettings(event)" title="Configurações"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
    </div>
    
    <div id="settingsMenu" class="settings-menu" onclick="event.stopPropagation()">
        <div class="settings-section">
            <div class="settings-title">Tema</div>
            <div class="theme-toggle"><div class="theme-opt active" id="themeDark" onclick="setTheme('dark')">Escuro</div><div class="theme-opt" id="themeLight" onclick="setTheme('light')">Claro</div></div>
        </div>
        <div class="settings-section" style="position: relative;">
            <div class="settings-title">Cor de Destaque</div>
            <div class="color-grid" id="colorGrid"></div>
            <div id="customColorModal" class="custom-color-modal" onclick="event.stopPropagation()">
                <div class="settings-title" style="align-self: flex-start; margin-bottom:5px;">Personalizar</div>
                <div id="colorPreview" class="color-preview-box"></div>
                <div class="slider-group"><span class="slider-label">Cor</span><input type="range" min="0" max="360" value="0" class="custom-slider" id="hueSlider" oninput="updateCustomColor()"></div>
                <div class="slider-group"><span class="slider-label">Intensidade</span><input type="range" min="0" max="100" value="70" class="custom-slider" id="satSlider" oninput="updateCustomColor()"></div>
                <div class="slider-group"><span class="slider-label">Luminosidade</span><input type="range" min="0" max="100" value="50" class="custom-slider" id="ligSlider" oninput="updateCustomColor()"></div>
                <button class="btn-confirm-style" style="width:100%; margin-top: 5px;" onclick="confirmCustomColor()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="main-card">
    <div class="main-title-box" onclick="toggleMainContent()">
        <h2>Impressão 3D em FDM</h2>
    </div>
    
    <div id="mainContentWrapper">
        <label>Impressora</label>
        <select id="selMaquina" onchange="updateSeletores()"><option value="" disabled selected>Selecionar...</option></select>
        <label>Filamento</label>
        <select id="selFilamento" onchange="updateSeletores()"><option value="" disabled selected>Selecionar...</option></select>
        
        <div class="side-by-side">
            <div><label>Tempo de Impressão</label><input type="text" id="tempo" placeholder="0d0h00m"></div>
            <div><label>Peso</label><input type="text" id="weight" placeholder="0g"></div>
        </div>
        
        <label>Fórmula de Cálculo</label>
        <div class="formula-radios">
            <div class="formula-opt"><input type="radio" name="formulaType" id="ftType" value="type" onchange="toggleFormula()"><label for="ftType">Tipo de Impressão</label></div>
            <div class="formula-opt"><input type="radio" name="formulaType" id="ftPercent" value="percent" onchange="toggleFormula()"><label for="ftPercent">Porcentagem</label></div>
        </div>
        <div id="formulaContainer"></div>

        <div class="extra-section">
            <div class="extra-header-row">
                <label style="margin:0;">Custos Adicionais</label>
                <button class="btn-simple-toggle" id="btnToggleExtra" onclick="document.getElementById('extrasBox').toggleAttribute('open')">+</button>
            </div>
            <div class="extras-chips-container" id="selectedExtrasContainer"></div>
            <details id="extrasBox">
                <summary></summary>
                <div id="tempExtraRow" class="temp-add-row">
                    <input type="text" id="newExtraName" class="suggest-edit-input" placeholder="Descrição">
                    <input type="number" id="newExtraVal" class="suggest-edit-input" style="width:60px" placeholder="R$">
                    <button class="btn-confirm-add" onclick="confirmAddExtra()">✔</button>
                </div>
                <div id="extrasListContent"></div>
                <div class="suggest-footer">
                    <button type="button" class="btn-footer-suggest" onclick="showAddExtraInput()">+ Tipo de Custo</button>
                    <button type="button" id="btnEditExtra" class="btn-footer-suggest" onclick="toggleEditExtra(event)">✎</button>
                </div>
            </details>
        </div>
        
        <button class="btn-main" onclick="calcularVenda()">CALCULAR VALOR</button>
        
        <div class="result" id="resultado" style="display:none;">
            <div class="result-title">PREÇO PARA VENDA DIRETA:</div>
            <span class="result-main-value" id="valorFinal">R$ 0,00</span>
            
            <div class="platform-row">
                <div class="platform-title shopee-title">Preço para Shopee (Taxas inclusas)</div>
                <div class="platform-value-row">
                    <span class="shopee-main-value" id="valShopee">R$ 0,00</span>
                    <span class="percent-tag tag-shopee" id="tagShopee">+0%</span>
                </div>
            </div>

            <div class="platform-row">
                <div class="platform-title ml-title">PREÇO PARA MERCADO LIVRE (PREMIUM + FRETE GRÁTIS)</div>
                <div class="platform-value-row">
                    <span class="ml-main-value" id="valML">R$ 0,00</span>
                    <span class="percent-tag tag-ml" id="tagML">+0%</span>
                </div>
            </div>

            <div class="detail-row"><span>Custo Operacional:</span><span id="resCustoOp">R$ 0,00</span></div>
            <div class="detail-row"><span>Custo do Material:</span><span id="resCustoMat">R$ 0,00</span></div>
            <div class="detail-row" id="rowExtra" style="display:none;"><span>Custos Adicionais:</span><span id="resCustoExtra">R$ 0,00</span></div>
            <div class="detail-row total-custo"><span>Custo de Produção:</span><span id="resCustoProd">R$ 0,00</span></div>
        </div>

        <div class="sub-section">
            <div class="header-config"><h3 style="margin:0; font-size: 14px;">Impressoras</h3><div class="header-btns"><button class="btn-icon-simple" id="btnEditMaq" onclick="toggleEditMaq(event)">✎</button><button class="btn-icon-simple" id="btnAddMaq" onclick="toggleFormMaq(event)">+</button></div></div>
            <table class="setup-table" id="tabMaq"><thead id="headMaq"></thead><tbody id="bodyMaq"></tbody></table>
            <div id="formMaq" class="form-novo" onclick="event.stopPropagation()">
                <label>Marca*</label><input type="text" id="mMarca">
                <label>Modelo*</label><input type="text" id="mModelo">
                <label>Valor do Equipamento*</label><input type="number" id="mEquipVal">
                <button class="btn-confirm-style" style="width:100%; margin-top:20px;" onclick="addMaq()">Adicionar</button>
            </div>
        </div>

        <div class="sub-section">
            <div class="header-config"><h3 style="margin:0; font-size: 14px;">Filamentos</h3><div class="header-btns"><button class="btn-icon-simple" id="btnEditFil" onclick="toggleEditFil(event)">✎</button><button class="btn-icon-simple" id="btnAddFil" onclick="toggleFormFil(event)">+</button></div></div>
            <table class="setup-table" id="tabFil"><thead id="headFil"></thead><tbody id="bodyFil"></tbody></table>
            <div id="formFil" class="form-novo" onclick="event.stopPropagation()">
                <label>Marca</label><input type="text" id="fMarca">
                <label>Material*</label><input type="text" id="fTipo">
                <label>Preço do Kg*</label><input type="number" id="fPreco">
                <label>Risco de Perda</label>
                <div class="selector-row" onclick="document.getElementById('suggestBox').toggleAttribute('open')"><span id="riscoAtualTexto">0%</span><input type="hidden" id="fRisco" value="0"><div class="arrow-down"></div></div>
                <details id="suggestBox">
                    <summary></summary>
                    <div id="tempRiskRow" class="temp-add-row"><input type="text" id="newRiskName" class="suggest-edit-input" placeholder="Material"><input type="number" id="newRiskVal" class="suggest-edit-input" style="width:60px" placeholder="%"><button class="btn-confirm-add" onclick="confirmAddRisk()">✔</button></div>
                    <div id="suggestListContent"></div>
                    <div class="suggest-footer"><button type="button" class="btn-footer-suggest" onclick="showAddRiskInput()">+ Risco Por Material</button><button type="button" id="btnEditSug" class="btn-footer-suggest" onclick="toggleEditSuggest(event)">✎</button></div>
                </details>
                <button class="btn-confirm-style" style="width:100%; margin-top:20px;" onclick="addFil()">Adicionar</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function downloadApp(){const e=document.documentElement.outerHTML,t=new Blob([e],{type:"text/html"}),n="Guias para Orçamento.html";if(window.showSaveFilePicker)try{const o=await window.showSaveFilePicker({suggestedName:n,types:[{description:"Arquivo HTML",accept:{"text/html":[".html"]}}]}),a=await o.createWritable();await a.write(t),await a.close();return}catch(e){if("AbortError"!==e.name)console.error(e);else return}const o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=n,document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(o)},100)}
    const colors=["#2ecc71","#3498db","#9b59b6","#e67e22","#e74c3c"];let tempCustomColor="";function initTheme(){const e=localStorage.getItem("theme_v50")||"dark",t=localStorage.getItem("color_v50")||colors[0];setTheme(e),setColor(t)}function toggleSettings(e){e.stopPropagation(),document.getElementById("settingsMenu").classList.toggle("open")}function setTheme(e){document.body.classList.toggle("light-mode","light"===e),document.getElementById("themeDark").classList.toggle("active","dark"===e),document.getElementById("themeLight").classList.toggle("active","light"===e),localStorage.setItem("theme_v50",e)}function setColor(e){document.documentElement.style.setProperty("--primary",e),localStorage.setItem("color_v50",e),renderColorGrid(e)}function renderColorGrid(e){const t=document.getElementById("colorGrid");t.innerHTML="",colors.forEach(n=>{const o=document.createElement("div");o.className=`color-swatch ${n===e?"active":""}`,o.style.backgroundColor=n,o.onclick=()=>setColor(n),t.appendChild(o)});const n=document.createElement("div");n.className="color-swatch custom-picker-btn",colors.includes(e)?n.innerHTML="<span>+</span>":(n.classList.add("active"),n.style.backgroundColor=e,n.style.color="transparent",n.style.border="2px solid var(--text)"),n.onclick=e=>{e.stopPropagation(),openCustomColorModal()},t.appendChild(n)}function openCustomColorModal(){const e=document.getElementById("customColorModal");document.getElementById("hueSlider").value=0,document.getElementById("satSlider").value=70,document.getElementById("ligSlider").value=50,updateCustomColor(),e.classList.add("open")}function updateCustomColor(){const e=document.getElementById("hueSlider").value,t=document.getElementById("satSlider").value,n=document.getElementById("ligSlider").value,o=`hsl(${e}, ${t}%, ${n}%)`;tempCustomColor=o,document.getElementById("colorPreview").style.backgroundColor=o,document.getElementById("satSlider").style.background=`linear-gradient(to right, #888, hsl(${e}, 100%, 50%))`,document.getElementById("ligSlider").style.background=`linear-gradient(to right, #000, hsl(${e}, 100%, 50%), #fff)`}function confirmCustomColor(){tempCustomColor&&setColor(tempCustomColor),document.getElementById("customColorModal").classList.remove("open")}
    function toggleMainContent(){const e=document.getElementById("mainContentWrapper");e.classList.contains("collapsed")?e.classList.remove("collapsed"):e.classList.add("collapsed")}
    
    let isEditMaq=!1,isEditFil=!1,isEditSug=!1,isEditExtra=!1,maquinas=JSON.parse(localStorage.getItem("maq3d_v50"))||[],filamentos=JSON.parse(localStorage.getItem("fil3d_v50"))||[],sugestoesRiscos=JSON.parse(localStorage.getItem("sug_riscos_v50"))||[],extrasList=JSON.parse(localStorage.getItem("extras_list_v50"))||[],selectedExtras=[];const formatBRL=e=>e.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2});
    
    function initCalculator(){document.getElementById("tempo").value="",document.getElementById("weight").value="",document.getElementById("resultado").style.display="none";const e=document.getElementsByName("formulaType");e.forEach(e=>e.checked=!1),toggleFormula(),selectedExtras=[],initTheme(),render()}
    function render(){renderTabela("Maq",maquinas,["marca","modelo","valorEquip","custoOp"],isEditMaq),renderTabela("Fil",filamentos,["marca","tipo","preco","risco","total"],isEditFil),renderSugestoes(),renderExtrasMenu(),renderSelectedExtras(),updateSeletores(),updateButtonStates(),localStorage.setItem("maq3d_v50",JSON.stringify(maquinas)),localStorage.setItem("fil3d_v50",JSON.stringify(filamentos)),localStorage.setItem("sug_riscos_v50",JSON.stringify(sugestoesRiscos)),localStorage.setItem("extras_list_v50",JSON.stringify(extrasList))}
    
    function toggleFormula(){const e=document.querySelector('input[name="formulaType"]:checked'),t=document.getElementById("formulaContainer");if(!e)return void(t.innerHTML="");"type"===e.value?t.innerHTML='<select id="selMargem"><option value="2.5" selected>Peça Simples ou até 6H</option><option value="3.0">Peça Normal ou 6-12h</option><option value="3.5">Peça Complexa ou 12-24h</option><option value="4.0">Peça Critica ou +24H</option></select><div class="helper-text">*Valores padronizados.</div>':t.innerHTML='<div style="position: relative;"><input type="number" id="inputMargemPercent" placeholder="" style="padding-right: 30px;"><span style="position: absolute; right: 15px; top: 12px; color: #888;">%</span></div><div class="helper-text">*Porcentagem sobre custos de produção.</div>'}
    
    function updateButtonStates(){const e=document.getElementById("btnEditMaq"),t=document.getElementById("btnEditFil"),n=document.getElementById("btnEditExtra"),o=document.getElementById("btnEditSug"),a=(e,t)=>{e.innerHTML="✎",t?e.classList.add("btn-edit-active"):e.classList.remove("btn-edit-active")};a(e,isEditMaq),a(t,isEditFil),a(n,isEditExtra),a(o,isEditSug)}
    
    function renderExtrasMenu(){const e=document.getElementById("extrasListContent");e.innerHTML="",extrasList.forEach((t,n)=>{const o=document.createElement("div");o.className="suggest-item-row",isEditExtra?o.innerHTML=`<div style="flex-grow:1; padding:10px; display:flex; gap:5px"><input class="suggest-edit-input" value="${t.nome}" onchange="updExtra(${n}, 'nome', this.value)"><input class="suggest-edit-input" style="width:70px" type="number" value="${t.valor}" onchange="updExtra(${n}, 'valor', this.value)"></div><div class="col-ctrl"><div class="ctrl-icon-box"><button class="btn-del-raw btn-icon-delete" onclick="remExtra(event, ${n})">✕</button></div></div>`:o.innerHTML=`<div class="suggest-data ${selectedExtras.includes(n)?"selected":""}" onclick="toggleSelectExtra(${n})"><span>${t.nome}</span><strong>${formatBRL(t.valor)}</strong></div>`,e.appendChild(o)}),updateButtonStates()}
    function showAddExtraInput(){document.getElementById("tempExtraRow").classList.add("active"),document.getElementById("newExtraName").focus()}
    function confirmAddExtra(){const e=document.getElementById("newExtraName").value,t=parseFloat(document.getElementById("newExtraVal").value);e&&!isNaN(t)?(extrasList.push({nome:e,valor:t}),document.getElementById("newExtraName").value="",document.getElementById("newExtraVal").value="",document.getElementById("tempExtraRow").classList.remove("active"),render()):alert("Preencha descrição e valor.")}
    function renderSelectedExtras(){const e=document.getElementById("selectedExtrasContainer");e.innerHTML="",0!==selectedExtras.length?(e.style.display="flex",selectedExtras.forEach(t=>{if(!extrasList[t])return;const n=document.createElement("div");n.className="extra-chip",n.innerHTML=`${extrasList[t].nome} <span>${formatBRL(extrasList[t].valor)}</span> <span class="extra-chip-rm" onclick="toggleSelectExtra(${t})">✕</span>`,e.appendChild(n)})):e.style.display="none"}
    function toggleEditExtra(e){e.stopPropagation(),isEditExtra=!isEditExtra,document.getElementById("tempExtraRow").classList.remove("active"),render()}
    function updExtra(e,t,n){extrasList[e][t]="valor"===t?parseFloat(n):n,render()}
    function remExtra(e,t){e.stopPropagation(),confirm("Excluir este item?")&&(extrasList.splice(t,1),selectedExtras=selectedExtras.filter(e=>e!==t).map(e=>e>t?e-1:e),render())}
    function toggleSelectExtra(e){selectedExtras.includes(e)?selectedExtras=selectedExtras.filter(t=>t!==e):selectedExtras.push(e),render()}

    function renderSugestoes(){const e=document.getElementById("suggestListContent");e.innerHTML="",sugestoesRiscos.forEach((t,n)=>{const o=document.createElement("div");o.className="suggest-item-row",isEditSug?o.innerHTML=`<div class="col-ctrl"><div class="ctrl-icon-box"><span class="ctrl-icon handle btn-icon-drag" onpointerdown="startDragSug(event, ${n})">☰</span></div></div><div style="flex-grow:1; padding:10px; display:flex; gap:5px"><input class="suggest-edit-input" value="${t.nome}" onchange="updSug(${n}, 'nome', this.value)"><input class="suggest-edit-input" style="width:40px" type="number" value="${t.risco}" onchange="updSug(${n}, 'risco', this.value)">%</div><div class="col-ctrl"><div class="ctrl-icon-box"><button class="btn-del-raw btn-icon-delete" onclick="remSug(event, ${n})">✕</button></div></div>`:o.innerHTML=`<div class="suggest-data" onclick="setRisco(${t.risco})"><span>${t.nome}</span><strong>${t.risco}%</strong></div>`,e.appendChild(o)}),updateButtonStates()}
    function showAddRiskInput(){document.getElementById("tempRiskRow").classList.add("active"),document.getElementById("newRiskName").focus()}
    function confirmAddRisk(){const e=document.getElementById("newRiskName").value,t=parseFloat(document.getElementById("newRiskVal").value);e&&!isNaN(t)?(sugestoesRiscos.push({nome:e,risco:t}),document.getElementById("newRiskName").value="",document.getElementById("newRiskVal").value="",document.getElementById("tempRiskRow").classList.remove("active"),render()):alert("Preencha material e porcentagem.")}
    function toggleEditSuggest(e){e.stopPropagation(),isEditSug=!isEditSug,document.getElementById("tempRiskRow").classList.remove("active"),renderSugestoes()}
    function updSug(e,t,n){sugestoesRiscos[e][t]="risco"===t?parseFloat(n):n}
    function remSug(e,t){e.stopPropagation(),confirm("Excluir risco?")&&(sugestoesRiscos.splice(t,1),renderSugestoes())}
    function setRisco(e){document.getElementById("fRisco").value=e,document.getElementById("riscoAtualTexto").innerText=e+"%",document.getElementById("suggestBox").removeAttribute("open")}

    /* --- CÁLCULO ATUALIZADO --- */
    function calcularVenda(){
        const e=document.getElementById("selMaquina"),t=document.getElementById("selFilamento");
        if(!e.value||!t.value)return void alert("Selecione a Impressora e o Filamento.");
        const n=parseFloat(e.value),o=parseFloat(t.value),a=parseTempo(document.getElementById("tempo").value),i=parsePeso(document.getElementById("weight").value),r=a*n,l=i*o,s=r+l,c=document.querySelector('input[name="formulaType"]:checked');
        if(!c)return void alert("Selecione uma Fórmula de Cálculo.");
        
        let d=0;
        if("type"===c.value){
            const e=parseFloat(document.getElementById("selMargem").value);
            d=s*e
        }else{
            const e=parseFloat(document.getElementById("inputMargemPercent").value)||0;
            d=s*(1+e/100)
        }
        
        let u=0;
        selectedExtras.forEach(e=>{extrasList[e]&&(u+=extrasList[e].valor)});
        const m=d+u; 
        
        // CALCULO SHOPEE
        const shopeeVal = (m + 4) / 0.8;
        let diffPercent = 0;
        if (m > 0) {
            diffPercent = ((shopeeVal - m) / m) * 100;
        }

        // CALCULO MERCADO LIVRE ATUALIZADO (6.50 fixo e 79.00 trava)
        let mlVal = (m + 6.50) / 0.81;

        if (mlVal >= 79.00) {
            mlVal = (m + 40.00) / 0.81;
        }

        let mlDiff = 0;
        if (m > 0) mlDiff = ((mlVal - m) / m) * 100;


        document.getElementById("resultado").style.display="block";
        document.getElementById("valorFinal").innerText=formatBRL(m);
        
        // Atualiza UI Shopee
        document.getElementById("valShopee").innerText = formatBRL(shopeeVal);
        document.getElementById("tagShopee").innerText = '+' + diffPercent.toFixed(0) + '%';

        // Atualiza UI Mercado Livre
        document.getElementById("valML").innerText = formatBRL(mlVal);
        document.getElementById("tagML").innerText = '+' + mlDiff.toFixed(0) + '%';

        document.getElementById("resCustoOp").innerText=formatBRL(r);
        document.getElementById("resCustoMat").innerText=formatBRL(l);
        document.getElementById("resCustoProd").innerText=formatBRL(s);
        const p=document.getElementById("rowExtra");
        u>0?(p.style.display="flex",document.getElementById("resCustoExtra").innerText=formatBRL(u)):p.style.display="none"
    }

    function parseTempo(input) {
        let str = input.toLowerCase().replace(/\s/g, '').replace(',', '.');
        if (!isNaN(parseFloat(str)) && !str.match(/[dhm:]/)) return parseFloat(str);

        let d = 0, h = 0, m = 0;

        // Formato HH:MM
        if (str.includes(':')) {
            let parts = str.split(':');
            h = parseFloat(parts[0]) || 0;
            m = parseFloat(parts[1]) || 0;
            return h + (m / 60);
        }

        // Formato XdYhZm
        let matchD = str.match(/(\d+(\.\d+)?)d/);
        if (matchD) d = parseFloat(matchD[1]);

        let matchH = str.match(/(\d+(\.\d+)?)h/);
        if (matchH) h = parseFloat(matchH[1]);

        let matchM = str.match(/(\d+(\.\d+)?)m/);
        if (matchM) m = parseFloat(matchM[1]);

        return (d * 24) + h + (m / 60);
    }
    
    function parsePeso(input) {
        if(!input) return 0;
        let str = input.toString().toLowerCase().replace(/\s/g, '').replace(',', '.');
        let val = parseFloat(str);
        if (isNaN(val)) return 0;
        if (str.includes('kg')) {
            return val * 1000;
        }
        return val; // Padrão gramas
    }

    function renderTabela(e,t,n,o){
        const a=document.getElementById("head"+e),i=document.getElementById("body"+e);
        if(a.innerHTML="",i.innerHTML="",0!==t.length||o){
            const r=a.insertRow();o&&((l=document.createElement("th")).className="col-ctrl",r.appendChild(l));
            n.forEach(t=>{const n=document.createElement("th"),o={marca:"Marca",modelo:"Modelo",valorEquip:"Valor do Equipamento",custoOp:"Custo Operacional"},a={marca:"Marca",tipo:"Material",preco:"Preço",risco:"Risco de Perda",total:"Custo do Material"};n.innerText="Maq"===e?o[t]:a[t],r.appendChild(n)});
            var l;o&&((l=document.createElement("th")).className="col-ctrl",r.appendChild(l));
            t.forEach((a,r)=>{
                const l=i.insertRow();
                if(o){(s=l.insertCell()).className="col-ctrl",s.innerHTML=`<div class="ctrl-icon-box"><span class="ctrl-icon handle btn-icon-drag" onpointerdown="startDrag(event, '${e}', ${r})">☰</span></div>`}
                n.forEach(n=>{
                    const i=l.insertCell();
                    if(o) {
                        // LOGICA DE CAMPO BLOQUEADO
                        if("custoOp"===n||"total"===n){
                            const t="Maq"===e?a.custoOp:a.preco/1e3*(1+a.risco/100);
                            i.innerHTML=`<input value="${formatBRL(t)}${"Maq"===e?"/h":"/g"}" readonly class="input-locked">`
                        } else {
                            const t="marca"===n||"modelo"===n||"tipo"===n?"text":"number";
                            i.innerHTML=`<input type="${t}" value="${a[n]}" onchange="updItem('${e}', ${r}, '${n}', this.value)">`
                        }
                    } else {
                        "custoOp"===n?i.innerHTML=`<span class="highlight">${formatBRL(a.custoOp)}/h</span>`:"total"===n?i.innerHTML=`<span class="highlight">${formatBRL(a.preco/1e3*(1+a.risco/100))}/g</span>`:"preco"===n&&"Fil"===e?i.innerHTML=`<span>${formatBRL(a[n])}/kg</span>`:"risco"===n&&"Fil"===e?i.innerHTML=`<span>${a[n]}%</span>`:"number"==typeof a[n]?i.innerText=formatBRL(a[n]):i.innerText=a[n]
                    }
                });
                var s;o&&((s=l.insertCell()).className="col-ctrl",s.innerHTML=`<div class="ctrl-icon-box"><button class="btn-del-raw btn-icon-delete" onclick="removerItem(event, '${e}', ${r})">✕</button></div>`)
            })
        }
    }
    
    function updateSeletores(){const e=document.getElementById("selMaquina"),t=document.getElementById("selFilamento");if(!e||!t)return;const n=e.value,o=t.value;e.innerHTML='""'===n?'<option value="" disabled selected>Selecionar...</option>':"",t.innerHTML='""'===o?'<option value="" disabled selected>Selecionar...</option>':"",maquinas.forEach(t=>e.innerHTML+=`<option value="${t.custoOp}" ${n==t.custoOp?"selected":""}>${t.marca} ${t.modelo}</option>`),filamentos.forEach(e=>t.innerHTML+=`<option value="${e.preco/1e3*(1+e.risco/100)}" ${o==e.preco/1e3*(1+e.risco/100)?"selected":""}>${(e.marca?e.marca+" ":"")+e.tipo}</option>`)}
    function limparCampos(){["mMarca","mModelo","mEquipVal","fMarca","fTipo","fPreco"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")}),document.getElementById("fRisco").value=0,document.getElementById("riscoAtualTexto").innerText="0%",document.getElementById("suggestBox").removeAttribute("open"),isEditSug=!1,renderSugestoes()}
    function startDragSug(e,t){let n=e.clientY;const o=e=>{let a=e.clientY-n;if(Math.abs(a)>40){let n=a>0?1:-1,r=t+n;r>=0&&r<sugestoesRiscos.length&&([sugestoesRiscos[t],sugestoesRiscos[r]]=[sugestoesRiscos[r],sugestoesRiscos[t]],t=r,start=e.clientY,renderSugestoes())}},a=()=>{document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",a)};document.addEventListener("pointermove",o),document.addEventListener("pointerup",a)}
    function startDrag(e,t,n){let o=e.clientY;const a=e=>{let i=e.clientY-o;if(Math.abs(i)>45){let o=i>0?1:-1,r="Maq"===t?maquinas:filamentos,l=n+o;l>=0&&l<r.length&&([r[n],r[l]]=[r[l],r[n]],n=l,start=e.clientY,render())}},i=()=>{document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",i)};document.addEventListener("pointermove",a),document.addEventListener("pointerup",i)}
    function updItem(e,t,n,o){const a="Maq"===e?maquinas:filamentos;if("marca"===n||"modelo"===n||"tipo"===n)a[t][n]=o;else{const i=parseFloat(o);isNaN(i)||(a[t][n]=i,"Maq"===e&&"valorEquip"===n&&(a[t].custoOp=.001*i))}render()}
    function addMaq(){const e=parseFloat(document.getElementById("mEquipVal").value);if(!document.getElementById("mMarca").value||isNaN(e))return;maquinas.push({marca:document.getElementById("mMarca").value,modelo:document.getElementById("mModelo").value,valorEquip:e,custoOp:.001*e}),document.getElementById("formMaq").style.display="none",limparCampos(),render()}
    function addFil(){const e=parseFloat(document.getElementById("fPreco").value);if(!document.getElementById("fTipo").value||isNaN(e))return;filamentos.push({marca:document.getElementById("fMarca").value,tipo:document.getElementById("fTipo").value,preco:e,risco:parseFloat(document.getElementById("fRisco").value)||0}),document.getElementById("formFil").style.display="none",limparCampos(),render()}
    function removerItem(e,t,n){e&&e.stopPropagation(),confirm("Excluir?")&&(("Maq"===t?maquinas:filamentos).splice(n,1),render())}
    function toggleEditMaq(e){e.stopPropagation(),0!==maquinas.length||isEditMaq?(isEditMaq=!isEditMaq,render()):void 0}
    function toggleEditFil(e){e.stopPropagation(),0!==filamentos.length||isEditFil?(isEditFil=!isEditFil,render()):void 0}
    function toggleFormMaq(e){e.stopPropagation(),document.getElementById("formMaq").style.display="block"}
    function toggleFormFil(e){e.stopPropagation(),document.getElementById("formFil").style.display="block"}
    function fecharModais(e){const t=document.getElementById("settingsMenu");t.classList.contains("open")&&!e.target.closest(".top-bar")&&t.classList.remove("open");const n=document.getElementById("customColorModal");n.classList.contains("open")&&!e.target.closest("#settingsMenu")&&n.classList.remove("open");const o=document.getElementById("formMaq"),a=document.getElementById("btnAddMaq");"block"===o.style.display&&!e.target.closest("#formMaq")&&e.target!==a&&(o.style.display="none",limparCampos());const i=document.getElementById("formFil"),r=document.getElementById("btnAddFil");"block"===i.style.display&&!e.target.closest("#formFil")&&e.target!==r&&(i.style.display="none",limparCampos()),isEditMaq&&!e.target.closest("#tabMaq")&&!e.target.closest("#btnEditMaq")&&(isEditMaq=!1,render()),isEditFil&&!e.target.closest("#tabFil")&&!e.target.closest("#btnEditFil")&&(isEditFil=!1,render()),isEditExtra&&!e.target.closest("#extrasBox")&&!e.target.closest("#btnEditExtra")&&(isEditExtra=!1,render()),isEditSug&&!e.target.closest("#suggestBox")&&!e.target.closest("#btnEditSug")&&(isEditSug=!1,renderSugestoes());const l=document.getElementById("extrasBox"),s=document.getElementById("btnToggleExtra");l.hasAttribute("open")&&!e.target.closest("#extrasBox")&&e.target!==s&&(l.removeAttribute("open"),document.getElementById("tempExtraRow").classList.remove("active"),isEditExtra=!1,render());const c=document.getElementById("suggestBox");c.hasAttribute("open")&&!e.target.closest("#suggestBox")&&!e.target.closest(".selector-row")&&(c.removeAttribute("open"),document.getElementById("tempRiskRow").classList.remove("active"),isEditSug=!1,renderSugestoes())}document.addEventListener("click",fecharModais),document.addEventListener("keydown",function(e){"Escape"===e.key&&(isEditMaq=!1,isEditFil=!1,isEditSug=!1,isEditExtra=!1,document.getElementById("formMaq").style.display="none",document.getElementById("formFil").style.display="none",document.getElementById("extrasBox").removeAttribute("open"),document.getElementById("suggestBox").removeAttribute("open"),document.getElementById("tempExtraRow").classList.remove("active"),document.getElementById("tempRiskRow").classList.remove("active"),document.getElementById("settingsMenu").classList.remove("open"),document.getElementById("customColorModal").classList.remove("open"),limparCampos(),render())}),initCalculator();
</script>
</body>
</html>
